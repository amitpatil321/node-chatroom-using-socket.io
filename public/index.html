<!doctype html>
<html>
    <head>
      <style type="text/css">
        .room{
          height: 400px;
          max-height: 400px;
          overflow: scroll;
        }
      </style>
    </head>
    <body>
      
      <div class="ui segments" style="margin:20% 30%">
        <div class="ui green segment teal inverted wintitle">
          <h4>Chatroom</h4>
        </div>
        <div class="ui segment room">
          <div class="ui dimmer">
            <div class="ui indeterminate text loader">Please enter your nick name to get started</div>
          </div>        
          <ul id="messages"></ul>
        </div>
        <div class="ui bottom attached message info">
          <form action="">

            <div class="ui fluid action input txtmessage">
              <input placeholder="Type message here..." type="text" id="txtmessage" autocomplete="off">
              <button type="submit" class="ui icon button positive">
                <i class="send icon"></i>
              </button>
            </div>

            <div class="ui fluid action input nickname" style="display:none;">
              <input placeholder="Ente your nick name" type="text" id="nickname" autocomplete="off">
              <button class="ui labeled positive icon button login">
                <i class="user icon"></i>
                Enter
              </button>
            </div>

          </form>
        </div>
      </div>

    <link rel="stylesheet" type="text/css" href="/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="http://semantic-ui.com/dist/components/grid.css">
    <script src="/js/jquery-3.1.0.min.js"></script>
    <script src="/js/semantic.min.js"></script>
    <script src="/js/moment.js"></script>
    <script src="/js/script.js"></script>
    <script src="/socket.io/socket.io.js"></script>
      <script>
      $().ready(function(){
        // Check if user already have nickname in localstorage
        var localNickname = getName();
        if(!localNickname){
          $(".dimmer").addClass("active");
          $(".nickname").show();
          $(".txtmessage").hide();
        }else{
          // Set window title
          $(".wintitle h4").append(" - "+localNickname);
          // Send user joined message to server
          socket.emit('newUser', localNickname);
        }

        // Store nickname
        $(".login").click(function(){
           var nickname = $("#nickname").val();

           if(nickname){
             // Store data in locastorage
             window.localStorage.setItem("nickname",nickname);
             // Hide nickname window and show msg input window
             $(".nickname").hide();
             $(".txtmessage").show();
             $(".dimmer").removeClass('active');  

             // Add name to window title
             $(".wintitle h4").append(" - "+window.localStorage.getItem("nickname"));

            // Send user joined message to server
            socket.emit('newUser', nickname);             
             
           }

        });
      });
      $('form').submit(function(e){
        e.preventDefault();
        var message = $('#txtmessage').val();
        if(message.length){
          // Send messgae to server 
          socket.emit('newMessage', message);
          // clear textbox
          $('#txtmessage').val('');
        }
      });

      var socket = io();
      // New message received
      socket.on('newMessage', function(obj){
        // append messge to existing messages
        console.log(obj);
        $('.room').append(
          $('<div style="display:none;">').html('<div class="ui comments"><div class="comment"><a class="avatar"><img src="https://randomuser.me/api/portraits/men/'+getName().length+'.jpg"></a><div class="content"><a class="author">'+getName()+'</a><div class="metadata"><span class="date">'+moment(obj.time).format("h:mm:ss A")+'</span></div><div class="text">'+obj.msg+'</div></div></div></div>').fadeIn()
        );

        // scroll to bottom
        $(".room").scrollTop = $(".room").scrollHeight;
      });

      //New user joined
      socket.on('newUser', function(data){
        // append messge to existing messages
        $('.room').append('<div class="ui small message info"><i class="icon info"></i>'+data+' Just joined us</div>');

        // scroll to bottom
        $(".room").scrollTop = $(".room").scrollHeight;
      });
    </script>
  </body>
</html>